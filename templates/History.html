<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Transaction History | Tradelink</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/component.css') }}">

</head>
<body>
    <div class="history-main-content">
        <div class="history-header">
            <span class="back-button">
                <button onclick="window.location.href='/'" title="Back to Dashboard">
                    <i class="fas fa-arrow-left" style="font-size:1.5em;"></i>
                </button>
            </span>
            <h1 class="history-title">Transaction History</h1>
        </div>
        <div class="filter-bar">
            <button class="filter-btn active" data-type="all" onclick="filterHistory('all', this)">All</button>
            <button class="filter-btn" data-type="deposit" onclick="filterHistory('deposit', this)">Deposits</button>
            <button class="filter-btn" data-type="withdraw" onclick="filterHistory('withdraw', this)">Withdrawals</button>
        </div>
        <div class="history-list" id="historyList">
            <!-- History will be rendered here by JS -->
        </div>
    </div>
    <!-- Toast moved to end of body for overlay priority -->
    <div id="spinner" class="spinner"></div>
    <!-- Transaction Detail Modal -->
    <div id="transactionModal" class="modal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.32);align-items:center;justify-content:center;">
        <div class="modal-content transaction-modal-card">
            <!-- Close button is now rendered dynamically in the modal header -->
            <div id="modalDetails"></div>
        </div>
    <style>
    .history-toast {
        position: fixed !important;
        left: 50% !important;
        bottom: 40px !important;
        transform: translateX(-50%) !important;
        z-index: 2147483647 !important;
        min-width: 180px;
        max-width: 90vw;
        background: var(--primary, #00456d) !important;
        color: #fff !important;
        padding: 0.9em 1.5em !important;
        border-radius: 10px !important;
        font-size: 1.08rem !important;
        text-align: center !important;
        box-shadow: 0 2px 12px rgba(0,0,0,0.18) !important;
        opacity: 0 !important;
        pointer-events: none !important;
        transition: opacity 0.3s, bottom 0.3s !important;
    }
    .history-toast.show {
        opacity: 1 !important;
        pointer-events: auto !important;
        bottom: 60px !important;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0; top: 0;
        width: 100vw; height: 100vh;
        background: var(--bg-color, #f5f7fa);
        color: var(--text-color, #212529);
        align-items: stretch;
        justify-content: stretch;
        animation: fadeIn 0.2s;
        overflow-y: auto;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .transaction-modal-card {
        background: var(--card-bg, #fff);
        width: 100vw;
        height: 100vh;
        margin: 0;
        border-radius: 0;
        box-shadow: none;
        padding: 0 0 1.5rem 0;
        position: relative;
        color: var(--text-color, #212529);
        display: flex;
        flex-direction: column;
        align-items: stretch;
        min-height: 100vh;
        max-width: 100vw;
        max-height: 100vh;
        overflow-y: auto;
    }
    .modal-close-btn {
        position: absolute;
        top: 16px;
        left: 22px;
        right: auto;
        background: none;
        border: none;
        font-size: 1rem;
        color: var(--primary, #00456d);
        cursor: pointer;
        z-index: 2;
        transition: color 0.2s;
        padding: 0 8px 0 0;
    }
    .modal-close-btn:hover { color: var(--accent-red, #f6465d); }
    .transaction-modal-header {
        display: flex;
        align-items: center;
        background: var(--primary, #00456d);
        border-radius: 0;
        padding: 1.2rem 1.5rem 1.2rem 1.5rem;
        font-size: 1.5rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 0.5rem;
        justify-content: center;
        position: relative;
    }
    .transaction-modal-header .transaction-modal-icon {
        margin-right: 0.7rem;
    }
    .transaction-modal-header .modal-close-btn {
        position: absolute;
        left: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        right: auto;
        font-size: 2.1rem;
        background: none;
        border: none;
        color: var(--primary, #00456d);
        z-index: 2;
        padding: 0 8px 0 0;
    }
    .transaction-modal-header.withdraw {
        background: var(--accent-red, #f6465d);
        color: #fff;
    }
    .transaction-modal-header.deposit {
        background: var(--accent-green, #0ecb81);
        color: #fff;
    }
    .transaction-modal-icon {
        font-size: 2.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .transaction-modal-details {
        padding: 0.5rem 1.5rem 0 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.1rem;
    }
    .transaction-modal-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 1.13rem;
        border-bottom: 1px solid var(--shadow, rgba(0,0,0,0.08));
        padding: 0.7rem 0 0.2rem 0;
    }
    .transaction-modal-label {
        color: var(--primary, #00456d);
        font-weight: 500;
        font-size: 1.08rem;
    }
    .transaction-modal-value {
        color: var(--text-color, #212529);
        font-weight: 600;
        font-size: 1.13rem;
        word-break: break-all;
    }
    .transaction-modal-status.completed { color: var(--accent-green, #0ecb81); font-weight: 700; }
    .transaction-modal-status.failed { color: var(--accent-red, #f6465d); font-weight: 700; }
    .transaction-modal-status.pending { color: #f0b90b; font-weight: 700; }
    .transaction-modal-copy {
        margin-left: 0.7rem;
        color: var(--primary, #00456d);
        font-size: 1.1rem;
        cursor: pointer;
        transition: color 0.2s;
        vertical-align: middle;
    }
    .transaction-modal-copy:hover { color: var(--accent-blue, #007aff); }
    @media (max-width: 600px) {
        .transaction-modal-card {
            max-width: 100vw;
            min-height: 100vh;
            padding: 0 0 1.2rem 0;
        }
        .transaction-modal-header {
            font-size: 1.1rem;
            padding: 1rem 0.7rem 1rem 0.7rem;
        }
        .transaction-modal-details {
            padding: 0.5rem 0.7rem 0 0.7rem;
        }
    }
    </style>
    </div>
    <script>
        // Show spinner immediately on page load
        document.getElementById('spinner').classList.remove('hidden');

        // Fetch and render history
        let transactionData = [];
        async function loadHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<div class="no-history">Loading...</div>';
            try {
                const res = await fetch('/api/history');
                const data = await res.json();
                if (!data.success || !data.history || data.history.length === 0) {
                    historyList.innerHTML = '<div class="no-history">No transfer history available.</div>';
                    window.hideSpinner();
                    return;
                }
                transactionData = data.history;
                historyList.innerHTML = '';
                data.history.forEach((item, idx) => {
                    const type = item.type?.toLowerCase() === 'withdraw' ? 'withdraw' : 'deposit';
                    const status = (item.status || '').toLowerCase();
                    let statusClass = '';
                    if (status === 'completed') statusClass = 'completed';
                    else if (status === 'failed') statusClass = 'failed';
                    else if (status === 'pending') statusClass = 'pending';
                    const icon = type === 'withdraw'
                        ? '<i class="fas fa-arrow-up"></i>'
                        : '<i class="fas fa-arrow-down"></i>';
                    const amount = Number(item.amount).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                    const date = (item.date || '').slice(0,10).replace(/-/g, '-');
                    // Add data-idx for click
                    historyList.innerHTML += `
                        <div class="history-card ${type}" data-idx="${idx}" tabindex="0" style="cursor:pointer;">
                            <div class="icon-type">${icon}</div>
                            <div class="history-card-content">
                                <div class="history-type-row">
                                    <span class="history-type ${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
                                    <span class="history-amount">$${amount}</span>
                                </div>
                                <div class="history-date-row">
                                    <span class="history-date">${date}</span>
                                    <span class="history-status ${statusClass}">${item.status ? item.status.charAt(0).toUpperCase() + item.status.slice(1) : ''}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                window.hideSpinner();
                // Add click listeners
                document.querySelectorAll('.history-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const idx = this.getAttribute('data-idx');
                        showTransactionModal(transactionData[idx]);
                    });
                    card.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            const idx = this.getAttribute('data-idx');
                            showTransactionModal(transactionData[idx]);
                        }
                    });
                });
            } catch (e) {
                historyList.innerHTML = '<div class="no-history">Failed to load history.</div>';
                window.hideSpinner();
            }
        }

        // Toast notification logic for this page
        window.showNotification = function(message, success) {
            var toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.add('show');
            if (success === false) {
                toast.style.background = 'var(--accent-red, #f6465d)';
            } else {
                toast.style.background = 'var(--primary, #00456d)';
            }
            setTimeout(function() {
                toast.classList.remove('show');
            }, 1800);
        };

        // Show transaction details in modal
        function showTransactionModal(item) {
            const modal = document.getElementById('transactionModal');
            const details = document.getElementById('modalDetails');
            if (!item) return;
            // Parse date/time
            let dateStr = '', timeStr = '';
            if (item.date) {
                const dt = new Date(item.date);
                if (!isNaN(dt)) {
                    dateStr = dt.toLocaleDateString(undefined, {year:'numeric',month:'2-digit',day:'2-digit'});
                    timeStr = dt.toLocaleTimeString(undefined, {hour:'2-digit',minute:'2-digit',second:'2-digit'});
                } else {
                    // fallback if not ISO
                    const parts = item.date.split(' ');
                    dateStr = parts[0] || '';
                    timeStr = parts[1] || '';
                }
            }
            const type = item.type?.toLowerCase() === 'withdraw' ? 'withdraw' : 'deposit';
            const icon = type === 'withdraw'
                ? '<span class="transaction-modal-icon" style="color:#f6465d;"><i class="fas fa-arrow-up"></i></span>'
                : '<span class="transaction-modal-icon" style="color:#0ecb81;"><i class="fas fa-arrow-down"></i></span>';
            let statusClass = '';
            if ((item.status||'').toLowerCase() === 'completed') statusClass = 'completed';
            else if ((item.status||'').toLowerCase() === 'failed') statusClass = 'failed';
            else if ((item.status||'').toLowerCase() === 'pending') statusClass = 'pending';
            // Build modal HTML
            let html = '';
            html += `<div class=\"transaction-modal-header ${type}\"><button class='modal-close-btn' style='left:0.4rem;top:50%;transform:translateY(-50%);right:auto;font-size:1.4em;background:none;border:none;color:var(--primary,#00456d);z-index:2;padding:0 8px 0 0;position:absolute;' onclick=\"document.getElementById('transactionModal').style.display='none'\"><i class='fas fa-arrow-left' style='font-size:1em;'></i></button>${icon}<span style=\"font-size:1.25em;vertical-align:middle;\">${type.charAt(0).toUpperCase() + type.slice(1)}</span></div>`;
            html += `<div class=\"transaction-modal-details\">`;
            // Amount
            html += `<div class=\"transaction-modal-row\"><span class=\"transaction-modal-label\">Amount:</span><span class=\"transaction-modal-value\">$${Number(item.amount).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span></div>`;
            // Time
            html += `<div class=\"transaction-modal-row\"><span class=\"transaction-modal-label\">Time:</span><span class=\"transaction-modal-value\">${item.time ? item.time : timeStr}</span></div>`;
            // Date
            html += `<div class=\"transaction-modal-row\"><span class=\"transaction-modal-label\">Date:</span><span class=\"transaction-modal-value\">${dateStr}</span></div>`;
            // Transaction ID
            if (item.transactionId) {
                html += `<div class=\"transaction-modal-row\"><span class=\"transaction-modal-label\">Transaction ID:</span><span class=\"transaction-modal-value transaction-id-copy\" style=\"cursor:pointer;user-select:all;\" tabindex=0 data-txid=\"${item.transactionId}\">${item.transactionId}</span></div>`;
            }
            // Sender/Recipient
            function maskWallet(val) {
                if (!val || val.length <= 8) return val;
                return val.slice(0,4) + '*****' + val.slice(-4);
            }
            if (item.type && item.wallet) {
                const maskedWallet = maskWallet(item.wallet);
                if (type === 'withdraw') {
                    html += `<div class=\"transaction-modal-row\"><span class=\"transaction-modal-label\">Recipient:</span><span class=\"transaction-modal-value\">${maskedWallet}</span></div>`;
                } else if (type === 'deposit') {
                    html += `<div class=\"transaction-modal-row\"><span class=\"transaction-modal-label\">Sender:</span><span class=\"transaction-modal-value\">${maskedWallet}</span></div>`;
                }
            }
            // Status
            html += `<div class=\"transaction-modal-row\"><span class=\"transaction-modal-label\">Status:</span><span class=\"transaction-modal-value transaction-modal-status ${statusClass}\">${item.status ? item.status.toUpperCase() : ''}</span></div>`;
            // Remarks
            if (item.remarks) {
                html += `<div class=\"transaction-modal-row\"><span class=\"transaction-modal-label\">Remarks:</span><span class=\"transaction-modal-value\">${item.remarks}</span></div>`;
            }
            html += `</div>`;
            details.innerHTML = html;
            modal.style.display = 'flex';

            // Copy transaction id on click/touch (iOS compatible, uses global toast)
            setTimeout(() => {
                const txidElem = document.querySelector('.transaction-id-copy');
                if (txidElem) {
                    let copied = false;
                    function fallbackCopy(text) {
                        const textarea = document.createElement("textarea");
                        textarea.value = text;
                        textarea.setAttribute("readonly", "");
                        textarea.style.position = "absolute";
                        textarea.style.left = "-9999px";
                        textarea.style.opacity = "0";
                        document.body.appendChild(textarea);
                        textarea.focus();
                        textarea.select();
                        // iOS selection
                        if (/ipad|iphone|ipod/i.test(navigator.userAgent)) {
                            textarea.setSelectionRange(0, textarea.value.length);
                        }
                        let successful = false;
                        try {
                            successful = document.execCommand('copy');
                        } catch (err) {
                            successful = false;
                        }
                        window.showNotification(successful ? "Transaction ID copied!" : "Copy failed", successful);
                        textarea.blur();
                        document.body.removeChild(textarea);
                        return successful;
                    }
                    function copyTxId(e) {
                        if (copied) return; // Prevent double trigger
                        copied = true;
                        e.preventDefault();
                        e.stopPropagation();
                        const txid = txidElem.getAttribute('data-txid');
                        if (txid) {
                            if (navigator.clipboard && window.isSecureContext && !/ipad|iphone|ipod/i.test(navigator.userAgent)) {
                                navigator.clipboard.writeText(txid)
                                    .then(() => window.showNotification("Transaction ID copied!", true))
                                    .catch(() => fallbackCopy(txid));
                            } else {
                                fallbackCopy(txid);
                            }
                            txidElem.style.color = '#0ecb81';
                            setTimeout(() => { txidElem.style.color = ''; copied = false; }, 700);
                        } else {
                            copied = false;
                        }
                    }
                    // Use only touchend for iOS, click for others
                    if (/ipad|iphone|ipod/i.test(navigator.userAgent)) {
                        txidElem.addEventListener('touchend', copyTxId);
                    } else {
                        txidElem.addEventListener('click', copyTxId);
                    }
                }
            }, 100);
        }

        // Modal close logic
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            document.getElementById('closeModalBtn').onclick = function() {
                document.getElementById('transactionModal').style.display = 'none';
            };
            document.getElementById('transactionModal').addEventListener('click', function(e) {
                if (e.target === this) this.style.display = 'none';
            });
        });

        // Filtering logic (unchanged)
        function filterHistory(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.history-card').forEach(card => {
                if (type === 'all') {
                    card.style.display = '';
                } else if (type === 'deposit') {
                    card.style.display = card.classList.contains('deposit') ? '' : 'none';
                } else if (type === 'withdraw') {
                    card.style.display = card.classList.contains('withdraw') ? '' : 'none';
                }
            });
        }
    </script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <div id="toast" class="history-toast"></div>
</body>
</html>